"use strict";(self.webpackChunkwhg_training_resources=self.webpackChunkwhg_training_resources||[]).push([[9174],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return f}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(n),f=r,d=m["".concat(l,".").concat(f)]||m[f]||g[f]||o;return n?a.createElement(d,i(i({ref:t},u),{},{components:n})):a.createElement(d,i({ref:t},u))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7541:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return g}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={sidebar_position:5},l=void 0,p={unversionedId:"programming/programming_with_gene_annotations/Converting_gff_to_sqlite",id:"programming/programming_with_gene_annotations/Converting_gff_to_sqlite",title:"Converting_gff_to_sqlite",description:"Up to table of contents",source:"@site/docs/programming/programming_with_gene_annotations/Converting_gff_to_sqlite.md",sourceDirName:"programming/programming_with_gene_annotations",slug:"/programming/programming_with_gene_annotations/Converting_gff_to_sqlite",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Converting_gff_to_sqlite",draft:!1,editUrl:"https://github.com/whg-training/whg-training-resources/docs/programming/programming_with_gene_annotations/Converting_gff_to_sqlite.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Refactoring_makes_code_better",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Refactoring_makes_code_better"},next:{title:"Gathering some first statistics",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_1"}},u={},g=[{value:"Writing a useful conversion program.",id:"writing-a-useful-conversion-program",level:2},{value:"Writing a command-line program",id:"writing-a-command-line-program",level:3},{value:"Parsing the data",id:"parsing-the-data",level:3},{value:"Outputting to sqlite",id:"outputting-to-sqlite",level:3},{value:"Job not done yet",id:"job-not-done-yet",level:2},{value:"Back to the task",id:"back-to-the-task",level:2}],m={toc:g};function f(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/"},"Up to table of contents")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Getting_started_writing_some_code"},"Back to the previous page")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_1"},"Go to the next page")),(0,o.kt)("h2",{id:"writing-a-useful-conversion-program"},"Writing a useful conversion program."),(0,o.kt)("p",null,"In the ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Getting_started_writing_some_code"},"first part of this tutorial")," you will have written some code to parse a\nGFF3 file and output a pandas dataframe.  I'll assume your function is called ",(0,o.kt)("inlineCode",{parentName:"p"},"parse_gff3_to_dataframe()"),"."),(0,o.kt)("p",null,"Your function is already useful! To demonstrate this, let's convert the GFF file into a different format - a ",(0,o.kt)("a",{parentName:"p",href:"https://www.sqlite.org"},"sqlite\ndatabase")," database. ",(0,o.kt)("inlineCode",{parentName:"p"},"sqlite")," is a very useful file format that works like a full database, but\ndoesn't require a server or anything like that - it's just a single file on the filesystem. But unlike a flat file, it\nis relational, making it easy to link records together. (This is ",(0,o.kt)("a",{parentName:"p",href:"%5Bhttps://pandas.pydata.org/docs/getting_started/comparison/comparison_with_sql.html#compare-with-sql-join"},"similar to pandas\nfunctionality")," but doesn't need to load all the data into memory.)"),(0,o.kt)("p",null,"To get started, put your function in a file called ",(0,o.kt)("inlineCode",{parentName:"p"},"gff.py"),". If you start python in the same\ndirectory you should now be able to write:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"import gff\ndata = gff.parse_gff3_into_dataframe('PlasmoDB-54_Pfalciparum3D7.head.gff')\nprint(data)\n")),(0,o.kt)("p",null,"Congratulations - you've written a python module!"),(0,o.kt)("h3",{id:"writing-a-command-line-program"},"Writing a command-line program"),(0,o.kt)("p",null,"We will use your ",(0,o.kt)("inlineCode",{parentName:"p"},"gff")," module to write a program called ",(0,o.kt)("inlineCode",{parentName:"p"},"gff_to_sqlite.py")," which:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"uses the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/argparse.html"},"argparse")," library to process\ncommand-line arguments for the input and output files.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"loads the data using your function above.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"stores the data in the output sqlite file."))),(0,o.kt)("p",null,"This turns out to be pretty easy. We'll start by importing the relevant stuff, and writing a\nfunction to parse the arguments. I find the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/argparse.html"},"argparse\ndocumentation")," a bit confusing, so here is\na quick head start:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'import argparse, sqlite3\nimport gff\n\ndef parse_arguments():\n    parser = argparse.ArgumentParser(\n        description = """Convert a GFF3 file to sqlite3 format.\n        The result will be a table with the GFF3 fields, and with ID and Parent fields in columns.\n        The resulting table will be indexed by the ID field for easy lookup."""\n    )\n    parser.add_argument(\n        \'--input\',\n        help =\'The path of a GFF3-formatted file to work with\',\n        required = True\n    )\n\n    # add other needed arguments here\n\n    return parser.parse_args()\n\nargs = parse_arguments()\n')),(0,o.kt)("p",null,"If you put this in a file called ",(0,o.kt)("inlineCode",{parentName:"p"},"gff_to_sqlite.py")," then you can run it from your shell like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ python3 gff_to_sqlite.py \nusage: gff_to_sqlite.py [-h] --input INPUT\ngff_to_sqlite.py: error: the following arguments are required: --input\n")),(0,o.kt)("p",null,"I'll leave you to fill in the other needed arguments here. You will need an ",(0,o.kt)("inlineCode",{parentName:"p"},"--output")," option to\nspecify the output file, and because sqlite files can contain several tables, maybe also a\n",(0,o.kt)("inlineCode",{parentName:"p"},"--table")," option to specify the output table name. (If you specify, say, ",(0,o.kt)("inlineCode",{parentName:"p"},'default = "gff_data"')," for\nthis, instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"required=True"),", the argument will have a default value.)"),(0,o.kt)("h3",{id:"parsing-the-data"},"Parsing the data"),(0,o.kt)("p",null,"This is easy right?  You've already written it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"data = gff.parse_gff_to_dataframe( args.input )\n")),(0,o.kt)("h3",{id:"outputting-to-sqlite"},"Outputting to sqlite"),(0,o.kt)("p",null,"This turns out to be easy too. Pandas dataframes have a ",(0,o.kt)("a",{parentName:"p",href:"https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_sql.html"},(0,o.kt)("inlineCode",{parentName:"a"},".to_sql()"),"\nfunction"),"\nthat does this for you. To make this work, you open the database and then run it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"db = sqlite3.connect( args.output )\ndata.to_sql( args.table, db, index = False )\n")),(0,o.kt)("p",null,"Finally you can, if you like, add a SQL index on the ID (or other columns) so lookups are quick:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'db.execute( "CREATE INDEX IF NOT EXISTS `%s_ID_index` ON `%s`( ID )" % (args.table, args.table ))\n')),(0,o.kt)("p",null,"Job done!  Run it in your shell like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ python gff_to_sqlite.py --input ../PlasmoDB-54_Pfalciparum3D7.head.gff --output genes.sqlite\n")),(0,o.kt)("p",null,"To check ths worked, you can use the ",(0,o.kt)("a",{parentName:"p",href:"www.sqlite.org"},"sqlite3 command-line client")," to look at the\nresult:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sqlite3 -header -column genes.sqlite \"SELECT COUNT(*) FROM gff_data WHERE type == 'gene'\"\n$ sqlite3 -header -csv genes.sqlite \"SELECT * FROM gff_data WHERE type == 'gene'\"\n$ sqlite3 -line genes.sqlite \"SELECT * FROM gff_data WHERE attributes LIKE '%Name=ABO%'\"\n")),(0,o.kt)("p",null,"Or load it back into python:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> import pandas, sqlite3\n>>> db = sqlite3.connect( "genes.sqlite" )\n>>> pandas.read_sql( "SELECT Parent, COUNT(*) AS number_of_transcripts FROM gff WHERE type == \'mRNA\' GROUP BY Parent", db )\n')),(0,o.kt)("p",null,"Or load it into R:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'library( RSQLite )\ndb = dbConnect( dbDriver( "SQLite" ), "genes.sqlite" )\ndbGetQuery( db, "SELECT Parent, COUNT(*) AS number_of_transcripts FROM gff WHERE type == \'mRNA\' GROUP BY Parent" )\n')),(0,o.kt)("p",null,"etc."),(0,o.kt)("p",null,"This combination of between-language interoperability and flexible querying are the main reasons to\nwrite this script in the first place. There's also another advantage which has to do with\ncontrolling memory, that we'll ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_2"},"come back to later"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning:")," Do check the output file size. For big organisms it can get quite big quite fast."),(0,o.kt)("h2",{id:"job-not-done-yet"},"Job not done yet"),(0,o.kt)("p",null,"To make this genuinely useful there are a few things still to do."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"You don't really want to leave your users hanging while your script processes stuff. It will\ntake not much of your time to add some ",(0,o.kt)("inlineCode",{parentName:"p"},"print()")," statements to the script to tell the user what it\nis doing, so you should do this. It will make you look good.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Your script is not so great at the moment if you want to process several files into the same\ndatabase - say several different organisms from\n",(0,o.kt)("a",{parentName:"p",href:"http://ftp.ensembl.org/pub/current_gff3/"},"Ensembl"),". (Try running the above twice and you'll see\nwhat I mean.) For one thing, you don't really know if the user wants to ",(0,o.kt)("em",{parentName:"p"},"append")," the data to the\nsame table, or ",(0,o.kt)("em",{parentName:"p"},"overwrite")," the table with the new one (this is a good candidate for another\ncommand-line argument.). For another thing, if you did run it twice it would be difficult to figure\nout which record came from which input file. Because of this I find it helps a lot to add an output\ncolumn that records an analysis name to distinguishes it from the other analyses. (This could\neither be taken from another command-line argument, or taken from the input filename. I tend to\ncall this column ",(0,o.kt)("inlineCode",{parentName:"p"},"analysis"),".)")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The script can take a while (minutes) to process some of the larger files. It would be very worthwhile\nto profile it to figure out if there are obvious slow bits that can be sped up. Profiling is beyond the scope of this\ntutorial, but at some point you're going to need it to make code fast. ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/profile.html"},"Here's how you can profile code in\npython"),".)")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"How much memory does the script use?  (Try running it and watching ",(0,o.kt)("inlineCode",{parentName:"p"},"top")," in another terminal)."))),(0,o.kt)("p",null,"My version of this code implements some of the above - it is in\n",(0,o.kt)("a",{target:"_blank",href:n(6405).Z},(0,o.kt)("code",null,"solutions/part1/gff_to_sqlite_dataframe_version.py")),". There is also ",(0,o.kt)("a",{target:"_blank",href:n(6109).Z},"a version that does not rely on pandas"),"."),(0,o.kt)("p",null,"I also tried profiling this code on a human gff file by running:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python3 -m cProfile gff_to_sqlite.py [arguments...]\n")),(0,o.kt)("p",null,"If I read the profiling output right, it is\ntaking 60% of its time inside ",(0,o.kt)("inlineCode",{parentName:"p"},"parse_attributes()"),". This means I could probably make it quite a bit\nfaster with some simple changes to ",(0,o.kt)("inlineCode",{parentName:"p"},"parse_gff3_to_dataframe()")," - we'll get back to this later."),(0,o.kt)("h2",{id:"back-to-the-task"},"Back to the task"),(0,o.kt)("p",null,"Now let's get ",(0,o.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_1"},"back to learning about genes"),"."))}f.isMDXComponent=!0},6405:function(e,t,n){t.Z=n.p+"assets/files/gff_to_sqlite_dataframe_version-b3cd86e00f4afc6c8d5dae626249f2dc.py"},6109:function(e,t,n){t.Z=n.p+"assets/files/gff_to_sqlite_python_version-d6ed86511df6a752656ae7c3dca04e44.py"}}]);